CH25 기능 확장 및 세그멘테이션/개인화 설계를 위한 기술 명세

이 문서는 CH25 프로젝트의 기존 프론트엔드·어드민 코드 구조를 분석하여, 새로 제안된 기능(사용자 데이터 수집, 세그멘테이션, 맞춤 캠페인, 쿠폰 코드, 랜덤 보상, 후기 게시판, 소셜 공유)을 구현하기 위한 구체적인 기술 설계를 제시한다.

1. 현재 구조 분석
1.1 프론트엔드 및 어드민 구조

일반 사용자 UI는 React + Vite로 작성되어 있으며, RoulettePage, DicePage, LotteryPage, RankingPage, SeasonPassPage 등 게임 페이지를 제공한다. 각 페이지는 src/hooks/useRoulette.ts 같은 커스텀 훅을 통해 백엔드 API와 통신한다. HTTP 클라이언트는 axios를 기반으로 한 userApi로 구성되어 있으며, 기본 URL은 .env의 VITE_API_BASE_URL를 참조한다
github.com
.

어드민 UI는 별도의 라우터(src/router/AdminRoutes.tsx)에서 관리된다. 대시보드와 SeasonListPage, RouletteConfigPage, DiceConfigPage, LotteryConfigPage, GameTokenGrantPage, GameTokenLogsPage, UserAdminPage 등의 페이지가 있으며, 백엔드 API는 adminApi (src/admin/api/httpClient.ts)를 통해 /admin/api 네임스페이스의 엔드포인트와 통신한다
github.com
.

데이터 관리는 프론트엔드에서 react-query를 통해 수행한다. 예를 들어 UserAdminPage는 createUser, fetchUsers 등의 API를 호출하여 사용자 CRUD를 제공한다
github.com
.

토큰/플레이 로그 관리는 GameTokenLogsPage에서 fetchWallets, fetchRecentPlayLogs, fetchLedger, revokeGameTokens 등을 호출하여 조회·회수를 수행한다
github.com
.

백엔드 스키마는 리포지토리 내에 포함되어 있지 않다. 다만 프론트 코드에서 사용되는 타입을 통해 백엔드 데이터 모델을 유추할 수 있다. 예를 들어 AdminUser 타입은 id, external_id, level, xp, season_level, status, created_at, updated_at 필드를 갖는다
github.com
. LedgerEntry는 id, user_id, token_type, delta, balance_after, reason, label, meta_json, created_at을 포함한다
github.com
.

1.2 기존 데이터 모델 추정

현재 어드민 API에서 사용되는 모델을 기반으로 다음과 같은 테이블을 추정할 수 있다:

users: id, external_id, nickname, level, xp, season_level, status, password_hash, created_at, updated_at.

game_wallets: id, user_id, token_type(ROULETTE_COIN/DICE_TOKEN/LOTTERY_TICKET), balance.

play_logs: id, user_id, game(roulette/dice/lottery), reward_type, reward_amount, reward_label, created_at
github.com
.

ledger: id, user_id, token_type, delta, balance_after, reason, label, meta_json, created_at
github.com
.

2. 데이터 수집 및 세그멘테이션 확장
2.1 사용자 행동 데이터 테이블 신설

신규 기능을 위해 다음과 같은 테이블을 추가한다. 백엔드에서는 ORM(예: Prisma/TypeORM) 또는 SQL 마이그레이션을 통해 생성한다.

user_activity
필드명	타입	설명
id	bigint PK	활동 고유 키
user_id	bigint FK→users.id	사용자 ID
last_login_at	datetime	마지막 로그인 시각
last_charge_at	datetime	마지막 충전(입금) 시각
roulette_plays	int	룰렛 플레이 누적 횟수
dice_plays	int	주사위 플레이 누적 횟수
lottery_plays	int	복권 스크래치 플레이 누적 횟수
total_play_duration	int	총 플레이 시간(초)
last_bonus_used_at	datetime	마지막 보너스 사용 시각
created_at	datetime	레코드 생성 시각
updated_at	datetime	레코드 업데이트 시각
수집 방식

게임 페이지에서 플레이 및 로그인 시 서버에 이벤트를 전송한다. 예) /api/activity/record 엔드포인트를 만들어 user_id, event_type(login, roulette_play 등), metadata를 전송하면, 서버는 user_activity의 해당 필드를 증가/갱신한다.

충전이 발생하면 백엔드가 last_charge_at을 갱신한다.

user_segment
필드명	타입	설명
user_id	bigint PK, FK→users.id	사용자 ID
segment	varchar	세그먼트 이름 (e.g., NEW, DORMANT_SHORT, DORMANT_LONG, VIP 등)
updated_at	datetime	최근 분류 시각

세그멘테이션 엔진이 정기적으로 user_activity를 분석하여 갱신한다. 예) 마지막 충전 이후 7일–14일: DORMANT_SHORT, 14일 이상: DORMANT_LONG 등.

2.2 세그멘테이션 엔진 모듈

주기적 작업(Cron Job): 하루에 한 번 모든 user_activity 데이터를 읽어 user_segment 테이블을 업데이트한다. 예를 들어 last_charge_at과 total_play_duration 등을 기준으로 그룹을 분류한다.

모듈 구조:

src/jobs/segmentUsers.ts (Node.js 스크립트)에서 쿼리를 수행하고 분류 규칙에 따라 세그먼트를 정의.

분류 규칙은 설정 테이블(segment_rules)에 저장하여 운영자가 변경 가능하도록 설계할 수 있다.

API: 어드민 UI에서 세그먼트 규칙을 조회·수정할 수 있도록 /admin/api/segments/rules (GET/PUT) 엔드포인트를 추가한다.

3. 캠페인·쿠폰·랜덤 리워드 설계
3.1 캠페인 관리
데이터 구조

campaigns: id, name, segment(적용 세그먼트), start_at, end_at, reward_type, reward_value, message_template, status, created_at, updated_at.

campaign_logs: id, campaign_id, user_id, delivered_at, redeemed_at, status, meta_json.

API 및 백엔드 처리

등록/수정/삭제: 어드민 UI에서 /admin/api/campaigns (GET, POST, PUT, DELETE)으로 캠페인 CRUD를 수행한다. reward_type은 토큰, 포인트, 쿠폰 등이 될 수 있다.

발송 엔진: 백엔드에서 Cron job 또는 워커를 통해 실행 중인 캠페인을 찾아 각 세그먼트의 대상자에게 알림을 발송한다. 발송 후 campaign_logs에 기록한다.

퍼널/통계: 캠페인 별 전환율을 집계하기 위해 /admin/api/campaigns/:id/stats를 추가한다.

어드민 UI

어드민 대시보드에 “캠페인 관리” 메뉴를 추가한다. 테이블 형태로 캠페인 목록을 보여주고 생성/수정 폼을 제공한다.

react-hook-form과 react-query를 이용해 캠페인 폼 및 데이터 조회를 구현한다.

3.2 쿠폰 코드 & 페이백
데이터 구조

coupons: id, code, type(percentage/fixed/free_spin/bonus_token), value, expires_at, usage_limit, used_count, segment(옵션), created_at, updated_at.

coupon_redemptions: id, coupon_id, user_id, redeemed_at, amount.

기능

발급: 어드민 UI에서 쿠폰을 생성하고 사용 한도와 적용 세그먼트를 지정한다. /admin/api/coupons CRUD 제공.

사용: 사용자 측에서 /api/coupons/redeem POST로 코드를 제출하면, 서버는 쿠폰을 검증하고 보상을 지급하며 coupon_redemptions에 기록한다.

페이백: 쿠폰 유형에 percentage를 사용하면 사용자 잔액의 일정 비율을 환급한다.

3.3 랜덤 리워드 풀
데이터 구조

reward_pools: id, name, segment(옵션), description.

reward_items: id, pool_id, reward_type(token/skin/coupon), reward_value, weight, quantity(수량 제한), meta_json.

사용자가 일정 조건을 만족하면 /api/rewards/open/:pool_id를 호출하여 서버에서 가중치에 따라 아이템을 반환한다. 잔여 수량이 있으면 감소시키고, 결과를 play_logs/ledger에 기록한다.

어드민 UI

랜덤 리워드 관리 페이지에서 풀과 아이템을 등록·편집한다. /admin/api/reward-pools 엔드포인트로 CRUD 수행.

4. 후기 게시판 및 소셜 공유
4.1 후기 게시판 데이터 구조

posts: id, user_id, title, content, rating(별점), game(roulette/dice/lottery), created_at, updated_at.

post_votes: id, post_id, user_id, type(like/dislike), created_at.

후기를 홈/랭킹 페이지에 간단히 표시하고, 상세 페이지에서 댓글/좋아요 기능을 제공한다.

4.2 소셜 공유 기능

프론트엔드에 각 게임 결과 또는 시즌패스 레벨업 시 결과를 공유할 수 있는 버튼을 추가한다. 예) kakaoShare() 또는 navigator.share() API를 호출하여 결과 링크와 메시지를 공유한다. 어드민에서는 공유 메시지 템플릿을 설정할 수 있도록 /admin/api/social/share-template을 추가한다.

5. 어드민 UI 확장 및 기존 페이지 통합
5.1 신규 페이지 추가

세그먼트 관리: /admin/segments 경로를 추가하여 세그먼트 목록과 규칙 수정 폼을 제공한다.

캠페인 관리: /admin/campaigns에서 캠페인 목록, 생성/수정/삭제 UI를 제공한다.

쿠폰 관리: /admin/coupons에서 쿠폰 목록/생성/수정/삭제를 관리한다.

리워드 풀 관리: /admin/reward-pools에서 랜덤 리워드 풀과 아이템을 관리한다.

게시판 관리: /admin/posts에서 후기 게시글을 검열/삭제할 수 있는 기능을 제공한다.

각 페이지는 react-query를 통한 API 호출과 yup 기반의 입력 검증을 사용한다.

5.2 기존 컴포넌트 활용

Button, Table 등 공통 컴포넌트를 재사용하여 일관성 있는 UI/UX를 유지한다.

FeatureGate를 사용해 신기능을 단계적으로 배포한다.

6. API 변경 및 백엔드 작업 요약
작업	상세	영향
새로운 엔드포인트 구현	/api/activity/record, /api/coupons/redeem, /api/rewards/open/:pool_id 등	사용자 앱 요청 처리
어드민 API 확장	/admin/api/segments, /admin/api/campaigns, /admin/api/coupons, /admin/api/reward-pools, /admin/api/posts 등	어드민 UI 지원
데이터베이스 마이그레이션	user_activity, user_segment, campaigns, campaign_logs, coupons, coupon_redemptions, reward_pools, reward_items, posts, post_votes 테이블 추가	백엔드 저장소 확장
Cron/워커 작업	세그멘테이션 엔진, 캠페인 발송, 랜덤 리워드 수량 감소 등	백엔드 작업자 필요
클라이언트 수정	새 페이지 라우팅, UI 컴포넌트, 훅 구현	프론트엔드 개발
7. 통합 및 배포 고려사항

스키마 버전 관리: 백엔드 코드와 DB 마이그레이션을 함께 버전 관리한다. 데이터 무결성을 위해 기존 테이블에 외래키 제약을 추가한다.

대량 데이터 처리: user_activity 업데이트 및 세그먼트 계산은 백엔드 워커(예: BullMQ)로 비동기 처리한다.

성능 최적화: user_activity와 play_logs 등에 인덱스를 추가해 조회 성능을 유지한다.

보안: 쿠폰 코드와 보너스 지급 시 재사용/중복 사용을 방지하도록 트랜잭션을 사용한다. 후기는 욕설 필터링·스팸 방지를 위해 검수 로직을 추가한다.

모바일 우선 UX: Tailwind의 모바일 퍼스트 설계 방법을 적용하여 모든 신규 페이지가 모바일 화면에서 잘 동작하도록 한다
tailwindcss.com
.